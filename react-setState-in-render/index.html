<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"
    />
    <title>react setState in render</title>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.1.0",
          "react-dom/client": "https://esm.sh/react-dom@19.1.0/client",
          "react/jsx-runtime": "https://esm.sh/react@19.1.0/jsx-runtime"
        }
      }
    </script>
  </head>
  <body>
    <h1>react setState while render</h1>
    <main id="app"></main>

    <script type="text/babel" data-type="module">
      import React, { useEffect, useState, useRef } from "react"; // → https://esm.sh/react@19.1.0
      import { createRoot } from "react-dom/client"; // → https://esm.sh/react-dom@19.1.0/client

      const root = createRoot(document.getElementById("app"));
      root.render(<App />);

      function App() {
        return (
          <>
            <h2>setState while render</h2>
            <Parent Child={ChildRederReset} />
            <h2>effect</h2>
            <Parent Child={ChildEffectReset} />
          </>
        );
      }

      function Parent({ Child }) {
        const logRef = useRef(null);
        const [parentState, setParentState] = useState(0);

        return (
          <div
            style={{
              padding: 8,
              border: "1px solid black",
              boxSizing: "border-box",
            }}
          >
            <button onClick={() => setParentState((c) => c + 1)}>
              update parentState: {parentState} + 1
            </button>
            <div style={{ padding: 8, border: "1px solid black" }}>
              <Child
                parentState={parentState}
                onUpdate={(message) => {
                  if (logRef.current) {
                    logRef.current.innerText += message + "\n";
                  }
                }}
              />
            </div>
            <p ref={logRef} style={{ width: "100%" }} />
          </div>
        );
      }

      function ChildRederReset({ parentState, onUpdate }) {
        const parentStateRef = useRef(parentState);
        const [childState, setChildState] = useState(0);

        // props 변경을 확인하면 자녀 상태 초기화 (render 중 업데이트)
        if (parentState !== parentStateRef.current) {
          // render 중 부모 상태 변경을 감지하면 자녀상태 초기화 수행.
          // render 중 setChildState를 수행하면 즉시 이전버전을 폐기하고 변경사항이 반영되어 log가 1회만 호출됨.
          // ChildEffectReset parentState: 1, childState: 0
          parentStateRef.current = parentState;
          setChildState(0);
        }

        useEffect(() => {
          onUpdate(
            `ChildRederReset parentState: ${parentState}, childState: ${childState}`
          );
        });

        return (
          <>
            <p>parentState 업데이트 시 render 중 초기화 수행</p>
            <p style={{ whiteSpace: "pre-line" }}>
              <code>
                {`if (parentState !== parentStateRef.current) {
                    parentStateRef.current = parentState;
                    setChildState(0);
                  }`}
              </code>
            </p>
            <button onClick={() => setChildState((state) => state + 1)}>
              update childState: {childState} + 1
            </button>
          </>
        );
      }

      function ChildEffectReset({ parentState, onUpdate }) {
        const [childState, setChildState] = useState(0);

        // props 변경에 반응해 이펙트에서 리셋 (커밋 후 업데이트)
        useEffect(() => {
          setChildState(0);
        }, [parentState]);

        useEffect(() => {
          // props 변경 시 1회, childState 초기화 시 1회 로그 출력됨.
          // ChildEffectReset parentState: 1, childState: 1
          // ChildEffectReset parentState: 1, childState: 0
          onUpdate(
            `ChildEffectReset parentState: ${parentState}, childState: ${childState}`
          );
        });

        return (
          <>
            <p>parentState 업데이트 시 effect 에서 초기화 수행</p>
            <p style={{ whiteSpace: "pre-line" }}>
              <code>
                {`useEffect(() => {
                    setChildState(0);
                  }, [parentState]);`}
              </code>
            </p>
            <button onClick={() => setChildState((state) => state + 1)}>
              update childState: {childState} + 1
            </button>
          </>
        );
      }
    </script>
  </body>
</html>
