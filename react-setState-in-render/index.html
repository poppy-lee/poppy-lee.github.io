<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"
    />
    <title>react setState in render</title>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.1.0",
          "react-dom/client": "https://esm.sh/react-dom@19.1.0/client",
          "react/jsx-runtime": "https://esm.sh/react@19/jsx-runtime"
        }
      }
    </script>
  </head>
  <body>
    <h1>react setState in render</h1>
    <main id="app"></main>

    <script type="text/babel" data-type="module">
      import React, { useEffect, useState } from "react"; // → https://esm.sh/react@19.1.0
      import { createRoot } from "react-dom/client"; // → https://esm.sh/react-dom@19.1.0/client

      const root = createRoot(document.getElementById("app"));
      root.render(<App />);

      function App() {
        const [useRederReset, setUseRederReset] = useState(true);
        const [counter, setCounter] = useState(0);

        return (
          <>
            <p>
              <label>
                use reset state on render
                <input
                  type="checkbox"
                  checked={useRederReset}
                  onChange={(event) => setUseRederReset(event.target.checked)}
                />
              </label>
            </p>
            <div style={{ padding: 8, border: "1px solid black" }}>
              <button onClick={() => setCounter((c) => c + 1)}>
                parent state update: {counter} + 1
              </button>
              <div style={{ padding: 8, border: "1px solid black" }}>
                {useRederReset ? (
                  <CounterRederReset counter={counter} />
                ) : (
                  <CounterEffectReset counter={counter} />
                )}
              </div>
            </div>
          </>
        );
      }

      function CounterRederReset({ counter }) {
        const [selected, setSelected] = useState(false);

        // 프롭 변경 감지용 (렌더 중 업데이트)
        const [prevCounter, setPrevCounter] = useState(counter);
        if (counter !== prevCounter) {
          // 상태 변경 즉시 이전버전 폐기
          setPrevCounter(counter);
          setSelected(false);
        }

        // selected: true 일 때 props가 업데이트 되면 초기화 되며 아래 로그 출력
        // CounterRederReset [layoutEffect commit] {counter: 3, selected: false}
        // CounterRederReset [effect post-commit] {counter: 3, selected: false}
        React.useLayoutEffect(() => {
          console.log("CounterRederReset [layoutEffect commit]", {
            counter,
            selected,
          });
        });

        React.useEffect(() => {
          console.log("CounterRederReset [effect post-commit]", {
            counter,
            selected,
          });
        });

        return (
          <>
            <button onClick={() => setSelected(true)}>select</button>
            <span data-testid="status">
              {selected ? "선택됨" : "선택 안됨"}
            </span>
          </>
        );
      }

      function CounterEffectReset({ counter }) {
        const [selected, setSelected] = useState(false);

        // props 변경에 반응해 이펙트에서 리셋 (커밋 후)
        useEffect(() => {
          setSelected(false);
        }, [counter]);

        // selected: true 일 때 props가 업데이트 되면 초기화 되며 아래 로그 출력
        // CounterEffectReset [layoutEffect commit] {counter: 2, selected: true}
        // CounterEffectReset [effect post-commit] {counter: 2, selected: true}
        // CounterEffectReset [layoutEffect commit] {counter: 2, selected: false}
        // CounterEffectReset [effect post-commit] {counter: 2, selected: false}
        React.useLayoutEffect(() => {
          console.log("CounterEffectReset [layoutEffect commit]", {
            counter,
            selected,
          });
        });

        React.useEffect(() => {
          console.log("CounterEffectReset [effect post-commit]", {
            counter,
            selected,
          });
        });

        return (
          <>
            <button onClick={() => setSelected(true)}>select</button>
            <span data-testid="status">
              {selected ? "선택됨" : "선택 안됨"}
            </span>
          </>
        );
      }
    </script>
  </body>
</html>
