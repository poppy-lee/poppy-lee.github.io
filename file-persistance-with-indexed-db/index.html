<!DOCTYPE html>
<html>
  <head>
    <style>
      img {
        width: 200px;
        height: 200px;
        border: 3px solid grey;
      }
    </style>
  </head>
  <body>
    <p>preview image</p>
    <img />
    <p>
      <label>
        input file
        <input type="file" accept="image/*" />
      </label>
    </p>

    <script>
      // ====== 설정값 ======
      const DB_NAME = "poppy-lee-database";
      const STORE_NAME = "files";
      const FILE_KEY = "file"; // 필요 시 파일명 등으로 교체

      // ====== 유틸: DB 열기(스토어 보장) ======
      function openDatabase() {
        return new Promise((resolve, reject) => {
          // 1) 우선 현재 버전으로 열어본다 (버전 미지정 = 최신)
          const request = indexedDB.open(DB_NAME);

          request.onupgradeneeded = (event) => {
            // 새 DB거나 버전이 올라가는 경우: 여기에서 스토어가 없으면 만든다
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              db.createObjectStore(STORE_NAME);
            }
          };

          request.onsuccess = (event) => {
            const database = event.target.result;

            // 스토어가 이미 있으면 OK
            if (database.objectStoreNames.contains(STORE_NAME)) {
              return resolve(database);
            }

            // 스토어가 없으면 버전을 올려 재오픈하면서 생성
            const newVersion = database.version + 1;
            database.close();

            const requestNext = indexedDB.open(DB_NAME, newVersion);
            requestNext.onupgradeneeded = (ev) => {
              const db2 = ev.target.result;
              if (!db2.objectStoreNames.contains(STORE_NAME)) {
                db2.createObjectStore(STORE_NAME);
              }
            };
            requestNext.onsuccess = (event) => resolve(event.target.result);
            requestNext.onerror = (event) => reject(event.target.error);
          };

          request.onerror = (event) => reject(event.target.error);
        });
      }

      // ====== 파일 저장 ======
      function saveFileToDatabase(database, key, fileOrBlob) {
        return new Promise((resolve, reject) => {
          const tx = database.transaction(STORE_NAME, "readwrite");
          const store = tx.objectStore(STORE_NAME);
          const putReq = store.put(fileOrBlob, key);

          putReq.onsuccess = () => resolve(true);
          putReq.onerror = (e) => reject(e.target.error);
        });
      }

      // ====== 파일 읽기 ======
      function getFileFromIndexedDB(db, key) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, "readonly");
          const store = tx.objectStore(STORE_NAME);
          const getReq = store.get(key);

          getReq.onsuccess = (e) => resolve(e.target.result ?? null);
          getReq.onerror = (e) => reject(e.target.error);
        });
      }

      (async function () {
        const dtatabase = await openDatabase();
        const file = await getFileFromIndexedDB(dtatabase, FILE_KEY);
        document.querySelector("img").src = URL.createObjectURL(file);
      })();

      // ====== change 이벤트에서 즉시 저장 ======
      let dbPromise = null;
      document
        .querySelector("input[type=file]")
        .addEventListener("change", async (event) => {
          const file = event.target.files && event.target.files[0];
          if (!file) {
            alert("선택된 파일이 없습니다.");
            return;
          }

          document.querySelector("img").src = URL.createObjectURL(file);

          try {
            // DB 오픈(스토어 보장)
            dbPromise = dbPromise || openDatabase();
            const db = await dbPromise;

            // 저장
            await saveFileToDatabase(db, FILE_KEY, file);
            alert(
              `저장 완료: ${file.name} (${file.type || "unknown type"}, ${
                file.size
              } bytes)`
            );
          } catch (error) {
            console.error(error);
            alert("에러: " + (error?.message || error));
          }

          event.target.value = "";
        });
    </script>
  </body>
</html>
