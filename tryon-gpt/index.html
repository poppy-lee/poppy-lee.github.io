<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Hand Tracking Stage 1-2 (Environment Camera)</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #111;
        color: #eee;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        height: 100vh;
      }

      h1 {
        margin: 16px 0 8px;
        font-size: 18px;
      }

      .info {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 8px;
        text-align: center;
        line-height: 1.4;
      }

      #container {
        position: relative;
        width: 640px;
        max-width: 100vw;
        aspect-ratio: 4 / 3;
        background: #000;
      }

      #input_video {
        display: none; /* ë””ë²„ê¹…ìš©ìœ¼ë¡œ ë³´ê³  ì‹¶ìœ¼ë©´ block ì²˜ë¦¬ */
      }

      #output_canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .status {
        font-size: 12px;
        margin-top: 6px;
        opacity: 0.7;
      }
    </style>

    <!-- MediaPipe JS (CDN) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <h1>Hand Tracking Stage 1â€“2</h1>
    <div class="info">
      í›„ë©´ì¹´ë©”ë¼(environment) ê¸°ì¤€<br />
      1ë‹¨ê³„: ì›¹ìº  ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ë°›ê¸°<br />
      2ë‹¨ê³„: ì† / ì†ëª© ëœë“œë§ˆí¬ ì¶”ì¶œ + ìº”ë²„ìŠ¤ì— í‘œì‹œ
    </div>

    <div id="container">
      <video id="input_video" playsinline></video>
      <canvas id="output_canvas"></canvas>
    </div>
    <div class="status" id="status">ì´ˆê¸°í™” ì¤‘...</div>

    <script>
      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const statusElem = document.getElementById("status");

      const VIDEO_WIDTH = 640;
      const VIDEO_HEIGHT = 480;

      canvasElement.width = VIDEO_WIDTH;
      canvasElement.height = VIDEO_HEIGHT;

      // MediaPipe Hands ì´ˆê¸°í™”
      const hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        },
      });

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7,
      });

      hands.onResults(onResults);

      async function init() {
        try {
          statusElem.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...";

          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: VIDEO_WIDTH,
              height: VIDEO_HEIGHT,
              // í›„ë©´ì¹´ë©”ë¼ ìš°ì„  ì‚¬ìš©
              facingMode: { ideal: "environment" },
            },
            audio: false,
          });

          videoElement.srcObject = stream;

          // ë©”íƒ€ë°ì´í„° ë¡œë“œ í›„ ì¬ìƒ
          await videoElement.play();

          statusElem.textContent =
            "í›„ë©´ì¹´ë©”ë¼ ì‚¬ìš© ì¤‘. ì†ì„ ì¹´ë©”ë¼ ìª½ìœ¼ë¡œ ë¹„ì¶°ë³´ì„¸ìš” ğŸ‘‹";
          // ë Œë” ë£¨í”„ ì‹œì‘
          requestAnimationFrame(onFrame);
        } catch (e) {
          console.error(e);
          statusElem.textContent =
            "ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTPS/ê¶Œí•œ/í›„ë©´ì¹´ë©”ë¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”)";
        }
      }

      // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ë¹„ë””ì˜¤ â†’ Hands
      async function onFrame() {
        if (videoElement.readyState === HTMLMediaElement.HAVE_ENOUGH_DATA) {
          try {
            await hands.send({ image: videoElement });
          } catch (e) {
            console.error("hands.send ì—ëŸ¬:", e);
          }
        }
        requestAnimationFrame(onFrame);
      }

      function onResults(results) {
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // *í›„ë©´ì¹´ë©”ë¼*ì´ë¯€ë¡œ ê±°ìš¸ì²˜ëŸ¼ ì¢Œìš°ë°˜ì „í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ê·¸ë¦¼
        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );

        if (
          results.multiHandLandmarks &&
          results.multiHandLandmarks.length > 0
        ) {
          for (let i = 0; i < results.multiHandLandmarks.length; i++) {
            const landmarks = results.multiHandLandmarks[i];

            // ì†ëª© (landmark[0]) ì •ë³´ ë¡œê·¸
            const wrist = landmarks[0];
            const wristPixelX = wrist.x * canvasElement.width;
            const wristPixelY = wrist.y * canvasElement.height;

            console.log(`Hand ${i} wrist:`, {
              norm: {
                x: wrist.x.toFixed(3),
                y: wrist.y.toFixed(3),
                z: wrist.z.toFixed(3),
              },
              pixel: {
                x: wristPixelX.toFixed(1),
                y: wristPixelY.toFixed(1),
              },
            });

            // ëœë“œë§ˆí¬ + ì—°ê²°ì„  ê·¸ë¦¼
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
              color: "#00FFAA",
              lineWidth: 3,
            });
            drawLandmarks(canvasCtx, landmarks, {
              color: "#FF0066",
              lineWidth: 1,
              radius: 3,
            });
          }
        }

        canvasCtx.restore();
      }

      init();
    </script>
  </body>
</html>
