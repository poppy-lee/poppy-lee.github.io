<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Hand Tracking Stage 1-2 Demo</title>
    <!-- ë ˆì´ì•„ì›ƒìš© ê°„ë‹¨ ìŠ¤íƒ€ì¼ -->
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #111;
        color: #eee;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        height: 100vh;
      }

      h1 {
        margin: 16px 0 8px;
        font-size: 18px;
      }

      .info {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 8px;
        text-align: center;
        line-height: 1.4;
      }

      #container {
        position: relative;
        width: 640px;
        max-width: 100vw;
        aspect-ratio: 4 / 3;
        background: #000;
      }

      /* ë¹„ë””ì˜¤ëŠ” í™”ë©´ì— ì•ˆ ë³´ì´ê³ , MediaPipe Camera ìœ í‹¸ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© */
      #input_video {
        display: none;
      }

      #output_canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .status {
        font-size: 12px;
        margin-top: 6px;
        opacity: 0.7;
      }
    </style>

    <!-- MediaPipe JS ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN) -->
    <!-- Camera ìœ í‹¸: getUserMedia + frame loop -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <!-- ëœë“œë§ˆí¬/ë¼ì¸ ê·¸ë ¤ì£¼ëŠ” ìœ í‹¸ -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <!-- Hands ì†”ë£¨ì…˜ -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <h1>Hand Tracking Stage 1â€“2</h1>
    <div class="info">
      1ë‹¨ê³„: ì›¹ìº  ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ë°›ê¸°<br />
      2ë‹¨ê³„: ì† / ì†ëª© ëœë“œë§ˆí¬ ì¶”ì¶œ + ìº”ë²„ìŠ¤ì— í‘œì‹œ
    </div>

    <div id="container">
      <video id="input_video" playsinline></video>
      <canvas id="output_canvas"></canvas>
    </div>
    <div class="status" id="status">ì´ˆê¸°í™” ì¤‘...</div>

    <script>
      // DOM ìš”ì†Œ ì°¸ì¡°
      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const statusElem = document.getElementById("status");

      // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¹„ë””ì˜¤ í•´ìƒë„ì™€ ë§ì¶”ê¸° ìœ„í•œ ê¸°ë³¸ ê°’
      const VIDEO_WIDTH = 640;
      const VIDEO_HEIGHT = 480;

      canvasElement.width = VIDEO_WIDTH;
      canvasElement.height = VIDEO_HEIGHT;

      // MediaPipe Hands ì´ˆê¸°í™”
      const hands = new Hands({
        locateFile: (file) => {
          // hands.wasm / ëª¨ë¸ íŒŒì¼ ë“± ë¡œë”© ê²½ë¡œ
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        },
      });

      // Hands ì˜µì…˜ ì„¤ì •
      hands.setOptions({
        maxNumHands: 2, // ìµœëŒ€ ì¸ì‹ ì† ê°œìˆ˜
        modelComplexity: 1, // 0 ë˜ëŠ” 1 (1ì´ ë” ì •í™•í•˜ì§€ë§Œ ë¬´ê±°ì›€)
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7,
      });

      // ê²°ê³¼ ì½œë°±
      hands.onResults(onResults);

      // WebCam â†’ MediaPipe Handsë¡œ í”„ë ˆì„ ì „ë‹¬
      let camera = null;

      async function init() {
        try {
          statusElem.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...";

          camera = new Camera(videoElement, {
            onFrame: async () => {
              // ë§¤ í”„ë ˆì„ë§ˆë‹¤ Handsì— í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ ì „ë‹¬
              await hands.send({ image: videoElement });
            },
            width: VIDEO_WIDTH,
            height: VIDEO_HEIGHT,
          });

          await camera.start();
          statusElem.textContent =
            "ì†ì„ ì¹´ë©”ë¼ì— ë¹„ì¶°ë³´ì„¸ìš” ğŸ‘‹ (ì†ëª© ì¢Œí‘œëŠ” ì½˜ì†”ì— ë¡œê·¸ë©ë‹ˆë‹¤)";
        } catch (e) {
          console.error(e);
          statusElem.textContent =
            "ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTPS/ê¶Œí•œ í™•ì¸ í•„ìš”)";
        }
      }

      // Hands ê²°ê³¼ ì²˜ë¦¬
      function onResults(results) {
        // ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° ì‹œì‘
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // í™”ë©´ì„ ì¢Œìš° ë°˜ì „í•´ì„œ "ê±°ìš¸"ì²˜ëŸ¼ ë³´ì´ê²Œ í•˜ê¸°
        canvasCtx.translate(canvasElement.width, 0);
        canvasCtx.scale(-1, 1);

        // ë¹„ë””ì˜¤ í”„ë ˆì„ ê·¸ë¦¬ê¸°
        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );

        // ì†ì´ ì¸ì‹ë˜ë©´ landmarksë¥¼ ê·¸ë¦¼
        if (
          results.multiHandLandmarks &&
          results.multiHandLandmarks.length > 0
        ) {
          for (let i = 0; i < results.multiHandLandmarks.length; i++) {
            const landmarks = results.multiHandLandmarks[i];

            // ì†ëª©(ëœë“œë§ˆí¬ ì¸ë±ìŠ¤ 0) ì¢Œí‘œ ë¡œê·¸ (ìº”ë²„ìŠ¤ ê¸°ì¤€ ì •ê·œí™” x,y,z)
            const wrist = landmarks[0];
            // MediaPipeëŠ” 0~1 ì •ê·œí™” ì¢Œí‘œ, ì—¬ê¸°ì„œëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ í”½ì…€ ì¢Œí‘œë„ ê³„ì‚°
            const wristPixelX = (1 - wrist.x) * canvasElement.width; // ì¢Œìš° ë°˜ì „ ê³ ë ¤
            const wristPixelY = wrist.y * canvasElement.height;

            console.log(`Hand ${i} wrist:`, {
              norm: { x: wrist.x, y: wrist.y, z: wrist.z },
              pixel: { x: wristPixelX.toFixed(1), y: wristPixelY.toFixed(1) },
            });

            // ëœë“œë§ˆí¬ ë° ì—°ê²°ì„  ê·¸ë¦¬ê¸° (ë¯¸ëŸ¬ë§ëœ ì¢Œí‘œê³„ì—ì„œ ê·¸ë¦¬ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
              color: "#00FFAA",
              lineWidth: 3,
            });
            drawLandmarks(canvasCtx, landmarks, {
              color: "#FF0066",
              lineWidth: 1,
              radius: 3,
            });
          }
        }

        canvasCtx.restore();
      }

      // ì´ˆê¸° ì‹œì‘
      init();
    </script>
  </body>
</html>
