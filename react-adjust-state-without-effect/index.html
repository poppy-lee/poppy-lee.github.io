<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"
    />
    <title>react adjust state without effect</title>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.1.0",
          "react-dom/client": "https://esm.sh/react-dom@19.1.0/client",
          "react/jsx-runtime": "https://esm.sh/react@19.1.0/jsx-runtime"
        }
      }
    </script>
  </head>
  <body>
    <h1>react adjust state without effect</h1>
    <a
      href="https://react.dev/learn/you-might-not-need-an-effect#adjusting-some-state-when-a-prop-changes"
      target="_blank"
    >
      you-might-not-need-an-effect#adjusting-some-state-when-a-prop-changes
    </a>
    <main id="app"></main>

    <script type="text/babel" data-type="module">
      import React, { useEffect, useState, useRef } from "react";
      import { createRoot } from "react-dom/client";

      const root = createRoot(document.getElementById("app"));
      root.render(<App />);

      function App() {
        return (
          <>
            <h2>adjusting state during render</h2>
            <Parent Child={ChildRenderReset} />
            <h2>adjusting state with effect</h2>
            <Parent Child={ChildEffectReset} />
          </>
        );
      }

      function Parent({ Child }) {
        const logRef = useRef(null);
        const [parentState, setParentState] = useState(0);

        return (
          <div
            style={{
              padding: 8,
              border: "1px solid black",
              boxSizing: "border-box",
            }}
          >
            <button onClick={() => setParentState((c) => c + 1)}>
              update parentState: {parentState} + 1
            </button>
            <div style={{ padding: 8, border: "1px solid black" }}>
              <Child
                parentState={parentState}
                onUpdate={(message) => {
                  if (logRef.current) {
                    logRef.current.innerText += message + "\n";
                  }
                }}
              />
            </div>
            <p ref={logRef} style={{ width: "100%" }} />
          </div>
        );
      }

      function ChildRenderReset({ parentState, onUpdate }) {
        const parentStateRef = useRef(parentState);
        const [childState, setChildState] = useState(0);

        // If the prop changed, reset child state during render (render-phase update).
        if (parentState !== parentStateRef.current) {
          // Detect the parent update during render and reset child state immediately.
          // Calling setState during render discards the current render and re-renders
          // with the updated state, so only the final (committed) log appears once.
          parentStateRef.current = parentState;
          setChildState(0);
        }

        useEffect(() => {
          onUpdate(
            `ChildRenderReset parentState: ${parentState}, childState: ${childState}`
          );
        });

        return (
          <>
            <p>On parentState update, reset childState during render</p>
            <p style={{ whiteSpace: "pre" }}>
              <code>
                {`if (parentState !== parentStateRef.current) {
  parentStateRef.current = parentState;
  setChildState(0);
}`}
              </code>
            </p>
            <button onClick={() => setChildState((state) => state + 1)}>
              update childState: {childState} + 1
            </button>
          </>
        );
      }

      function ChildEffectReset({ parentState, onUpdate }) {
        const [childState, setChildState] = useState(0);

        // Reset in an effect in response to prop changes (post-commit).
        useEffect(() => {
          setChildState(0);
        }, [parentState]);

        useEffect(() => {
          // When props change: one log with the previous childState,
          // then another log after the reset (total two logs).
          onUpdate(
            `ChildEffectReset parentState: ${parentState}, childState: ${childState}`
          );
        });

        return (
          <>
            <p>On parentState update, reset childState in an effect</p>
            <p style={{ whiteSpace: "pre" }}>
              <code>
                {`useEffect(() => {
  setChildState(0);
}, [parentState]);`}
              </code>
            </p>
            <button onClick={() => setChildState((state) => state + 1)}>
              update childState: {childState} + 1
            </button>
          </>
        );
      }
    </script>
  </body>
</html>
